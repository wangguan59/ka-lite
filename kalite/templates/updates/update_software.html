{% extends 'base_distributed.html' %}

{% load i18n %}
{% load staticfiles %}
{% load my_filters %}

{% block update_active %}active{% endblock update_active %}

{% block title %}{% trans "Update Software" %}{% endblock %}

{% block headcss %}
<link rel="stylesheet" type="text/css" href="{% static 'css/jquery-ui/jquery-ui.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/updates.css' %}" />

<style>

.vertical-shadow{
    margin-left: 5px;
    margin-bottom: 10px;
    padding-bottom: 10px;
}

.container{
    margin-left: 130px;
}

.btn{
    margin-left: 40px;
    margin-top: 130px;
}

h2{
    font-size: 24px;
    margin-left: 45px;
}

img{
    margin-left: 15px;
}




</style>
{% endblock headcss %}

{% block headjs %}
<script type="text/javascript" src="{% static "js/bootstrap.min.js" %}"></script>
<script type="text/javascript" src="{% static 'js/jquery-ui/jquery-ui.min.js' %}"></script>
<script src="{% static 'js/updates.js' %}"></script>
<script type="text/javascript">
// Callback functions 

function software_start_callback(progress_log, resp) {
    if (!progress_log) {
        clear_messages()
        show_message("error", resp.status_code + resp.responseText);
    }
}

function software_check_callback(progress_log, resp) {
    // When video status is checked
    if (progress_log) { // check succeeded

        if (progress_log.stage_percent == 1.) {
            // 100% done with the video
            setNodeClass(currentKey, "complete");
            if (progress_log.process_percent == 1.) {
                // 100% done with ALL videos.
                $(".progress-section, #cancel-download").hide();
                updatesReset(progress_log.process_name);
                if ($(".subtitle-section:visible").length == 0) {
                    $("#cancel-download").hide();
                }
                return;
            }

        } else if (progress_log.completed) {
            // Completed without 100% done means there was a problem.
            $("#retry-video-download").show();
            $("#cancel-download").hide();
        } else {
            // Everything's good for now!
            $("#retry-video-download").hide();
            $("#cancel-download").show();
        }
        $("#cancel-download").show();
    } else { // check failed.
        switch (resp.status) {
            case 403:
                window.location.reload()  // Only happens if we were remotely logged out.
                break;
            default:
                show_message("error", "Error downloading videos: " + resp.responseText);
                clearInterval(window.download_subtitle_check_interval)
                break;
        }
    }
}

var software_callbacks = {
    start: software_start_callback,
    check: software_check_callback,
};
</script>

<script type="text/javascript">
function version_callback(data) {
    // Check to see if the remote software matches the local software version.
    //   If not, alert the user!
    var current_version = "{{ software_version }}";
    var remote_version = data.version;
    if (current_version != remote_version) {
        alert("update available!" + current_version + remote_version);
    }
}

function download_urls_callback(data) {
    window.data = data;
    for (key in data) {
         $("#software_available").append("<option value='" + data[key].url + "'>" + key + " (" + data[key].size + "MB)</option>");
    }
}
</script>

<script type="text/javascript">
    $(function() {
        updatesStart("update", 5000, software_callbacks)

        setTimeout(function() {
            get_server_status({path: "{% url get_server_info %}"}, ["online"], function(status){
                // We assume the distributed server is offline.
                //   if it's online, then we show all tools only usable when online.
                //
                // Best to assume offline, as online check returns much faster than offline check.
                if(false && (!status || !status["online"])){
                    show_message("error", "{% trans 'Distributed server is offline; cannot access video nor subtitle updates.' %}", " id_offline_message")
                } else {
                    $("#software_available").removeAttr("disabled");
                    $("#download-update-kalite").removeAttr("disabled");
                    $("#upload-update-kalite").removeAttr("disabled");
                    clear_message("id_offline_message")
                }
            });

        }, 200);

        $("#download-update-kalite").click(function() {
            // Get all videos to download
            //updatesStart("update", 1000, software_callbacks)

            // Start the download and updating process
            doRequest("{% url start_update_kalite %}", { "url": $("#software_available option:selected")[0].value })
                .success(function() {
                    updatesStart_callback("update")
                }).fail(function(response) {
                    show_message("error", "Error starting update process (" + response.status + "): " + response.responseText);
                });

            // Update the UI to reflect that we're waiting to start
            $("#cancel-update").show();
        });
        // onload    
    });
</script>
{% endblock headjs %}

{% block content %}
<!---Breadcrumb -->
<ul class="breadcrumb">
  <li><a href="{% url homepage %}">Home</a> <span class="divider">/</span></li>
  <li><a href="{% url update %}">Update</a> <span class="divider">/</span></li>
  <li class="active">System Update</li>
</ul>




<!---Current System status -->
<div>
    <div class="vertical-shadow">
        <div class= "row">
                <h2>{% trans "Current KA Lite" %}</h2>
        </div>

        <div class= "row">
            <div class="span3">
                <img src="http://placehold.it/200x150">
            </div>

            <div class="span6">
                <dl class="dl-horizontal">
                    <dt>Current Version:</dt>
                    <dd>0.092</dd>
                    <dt>Release Date:</dt>
                    <dd>Sep 3, 2013</dd>
                    <dt>Size:</dt>
                    <dd>19.03 MB</dd>
                    <dt>Device ID:</dt>
                    <dd>1eqrvaqewrm2848vadsfk</dd>
                    <dt>Last changed at:</dt>
                    <dd>{{ database_last_updated }}</dd>
                    <dt>File Directory:</dt>
                    <dd>{{ install_dir }}</dd>
                    </dl>
            </div>

        </div>
    </div>


    <div class="vertical-shadow">
        <div class= "row">
                <h2>{% trans "New Updates" %}</h2>
        </div>

        <div class= "row">

            <div class="span6">
                <dl class="dl-horizontal">
                    <dt>Latest Version:</dt>
                    <dd>0.10 <span class="label label-info">New</span> </dd>
                    <dt>Release Date:</dt>
                    <dd>Sep 3, 2013</dd>
                    <dt>Description:</dt>
                    <dd>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec cursus nunc et est rutrum feugiat. Cras fermentum odio ac ante placerat, ut pharetra mi dignissim. Fusce sed urna aliquam, placerat ipsum at, pretiumtortor ac, bibendum turpis.</dd>
                    </dl>
            </div>

            <div class="span3">
                <button class="btn btn-large btn-primary" type="button">Download and update</button>
            </div>

        </div>
    </div>

</div>











<div>
    <select id="software_available" >
    </select>

    <button id="download-update-kalite" type="button" disabled>{% trans "Update KA Lite from remote download" %}</button>
    <button id="upload-update-kalite" type="button" disabled>{% trans "Update KA Lite from file" %}</button>
    <button id="cancel-update-kalite" type="button" disabled>{% trans "Cancel update" %}</button>
</div>

<div style="clear: both;"></div>

<!-- note: id must match the "updates" app process name -->
<div id="update-progressbar">
    {% include "updates/progress-bar.html" %}
</div>
<div style="clear: both;"></div>

<div>
<span>Current version: {{ software_version }}</span><br />
<span>Current install directory: {{ install_dir }}</span><br />
<span>Current database last-updated: {{ database_last_updated }}</span><br />
</div>
<div style="clear: both;"></div>
<!-- fake way to do JSONP -->
<script type="text/javascript" src="{% central_server_api path='/api/version' %}?callback=version_callback"></script>
<script type="text/javascript" src="{% central_server_api path='/api/download/kalite/' %}?callback=download_urls_callback"></script>

{% endblock content %}
